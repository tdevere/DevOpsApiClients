"""
Pester test template for Azure DevOps API operations.
"""

from _generator.operation_def import OperationDef


def render_pester_test(op: OperationDef) -> str:
    """Render a Pester v5 test file from an OperationDef."""
    lines = []

    lines.append('# AUTO-GENERATED by _generator — do not edit by hand.')
    lines.append('<#')
    lines.append('.SYNOPSIS')
    lines.append(f'    Pester offline unit tests for {op.ps_script_name}')
    lines.append('')
    lines.append('.DESCRIPTION')
    lines.append(f'    Mocks Invoke-RestMethod to validate URL construction,')
    lines.append(f'    auth headers, response parsing, and error handling.')
    lines.append('#>')
    lines.append('')

    lines.append('BeforeAll {')
    lines.append(f"    $ScriptPath = Join-Path $PSScriptRoot '..' '{op.ps_script_name}'")
    lines.append(f"    $FixturePath = Join-Path $PSScriptRoot 'fixtures'")
    if op.project_scoped:
        lines.append("    $ProjectGuid = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'")
    lines.append('}')
    lines.append('')

    # Determine domain tag
    domain_tag = op.domain
    if domain_tag == "WorkItemTracking":
        domain_tag = "WIT"

    lines.append(f"Describe '{op.ps_script_name}' -Tag 'Offline', '{domain_tag}' {{")
    lines.append('')

    # Input validation context
    lines.append("    Context 'Input validation' {")
    lines.append('')

    # Build a default param string for calls — always pass ALL params explicitly
    # to avoid picking up env var defaults during validation tests
    cli_params = [p for p in op.params if p.cli_flag]
    _pester_skip = {"AZURE_DEVOPS_ORG", "AZURE_DEVOPS_PAT"}
    if op.project_scoped:
        _pester_skip.add("PROJECT_ID")
    env_params = [p for p in op.params if not p.cli_flag and p.env_var not in _pester_skip]

    def _make_call(skip_param=None, empty_param=None):
        """Build param string. empty_param gets '' instead of being omitted."""
        parts = []
        if empty_param == "Organization":
            parts.append("-Organization ''")
        elif skip_param != "Organization":
            parts.append("-Organization 'testorg'")
        if op.project_scoped:
            if empty_param == "ProjectId":
                parts.append("-ProjectId ''")
            elif skip_param != "ProjectId":
                parts.append("-ProjectId $ProjectGuid")
        for p in cli_params:
            ps_name = p.ps_name or _to_pascal(p.name)
            if empty_param == ps_name:
                parts.append(f"-{ps_name} ''")
            elif skip_param != ps_name:
                parts.append(f"-{ps_name} 'testvalue'")
        for p in env_params:
            ps_name = p.ps_name or _to_pascal(p.name)
            if empty_param == ps_name:
                parts.append(f"-{ps_name} ''")
            elif skip_param != ps_name:
                parts.append(f"-{ps_name} 'testvalue'")
        if empty_param == "Pat":
            parts.append("-Pat ''")
        elif skip_param != "Pat":
            parts.append("-Pat 'fakepat'")
        return ' '.join(parts)

    lines.append("        It 'Throws when Organisation is empty' {")
    lines.append(f"            {{")
    lines.append(f"                & $ScriptPath {_make_call(empty_param='Organization')}")
    lines.append(f"            }} | Should -Throw '*is required*'")
    lines.append("        }")
    lines.append('')

    if op.project_scoped:
        lines.append("        It 'Throws when ProjectId is empty' {")
        lines.append(f"            {{")
        lines.append(f"                & $ScriptPath {_make_call(empty_param='ProjectId')}")
        lines.append(f"            }} | Should -Throw '*is required*'")
        lines.append("        }")
        lines.append('')

    # Validation for extra env params (e.g., ProjectId when not project_scoped, RepositoryId, etc.)
    for p in env_params:
        ps_name = p.ps_name or _to_pascal(p.name)
        lines.append(f"        It 'Throws when {ps_name} is empty' {{")
        lines.append(f"            {{")
        lines.append(f"                & $ScriptPath {_make_call(empty_param=ps_name)}")
        lines.append(f"            }} | Should -Throw '*is required*'")
        lines.append("        }")
        lines.append('')

    lines.append("        It 'Throws when Pat is empty' {")
    lines.append(f"            {{")
    lines.append(f"                & $ScriptPath {_make_call(empty_param='Pat')}")
    lines.append(f"            }} | Should -Throw '*is required*'")
    lines.append("        }")
    lines.append("    }")
    lines.append('')

    # Successful API call context
    lines.append("    Context 'Successful API call (mocked)' {")
    lines.append('')
    lines.append('        BeforeAll {')
    lines.append(f"            $fixture = Get-Content (Join-Path $FixturePath '{op.fixture_filename}') -Raw | ConvertFrom-Json")
    lines.append('        }')
    lines.append('')

    mock_cmdlet = "Invoke-RestMethod" if op.success_status != 204 else "Invoke-WebRequest"
    full_call = _make_call()

    lines.append("        It 'Calls the correct URL' {")
    lines.append(f"            Mock {mock_cmdlet} {{ return $fixture }} -Verifiable")
    lines.append('')
    lines.append(f"            & $ScriptPath {full_call} | Out-Null")
    lines.append('')
    lines.append(f"            Should -InvokeVerifiable")

    # Build expected URL
    url_path = op.url_path
    for p in op.params:
        placeholder = '{' + p.name + '}'
        if placeholder in url_path:
            url_path = url_path.replace(placeholder, 'testvalue')

    if op.project_scoped:
        expected_uri = f"https://{op.base_host}/testorg/$ProjectGuid/{url_path}?api-version={op.api_version}"
    else:
        expected_uri = f"https://{op.base_host}/testorg/{url_path}?api-version={op.api_version}"

    method_cap = op.http_method.capitalize()
    lines.append(f"            Should -Invoke {mock_cmdlet} -Times 1 -Exactly -ParameterFilter {{")
    lines.append(f'                $Uri -eq "{expected_uri}" -and')
    lines.append(f"                $Method -eq '{method_cap}'")
    lines.append(f"            }}")
    lines.append("        }")
    lines.append('')

    lines.append("        It 'Sends correct Authorization header' {")
    lines.append("            $expectedAuth = [Convert]::ToBase64String(")
    lines.append("                [Text.Encoding]::ASCII.GetBytes(':fakepat')")
    lines.append("            )")
    lines.append('')
    lines.append(f"            Mock {mock_cmdlet} {{ return $fixture }}")
    lines.append('')
    lines.append(f"            & $ScriptPath {full_call} | Out-Null")
    lines.append('')
    lines.append(f"            Should -Invoke {mock_cmdlet} -Times 1 -ParameterFilter {{")
    lines.append("                $Headers['Authorization'] -eq \"Basic $expectedAuth\"")
    lines.append("            }")
    lines.append("        }")
    lines.append("    }")
    lines.append('')

    # HTTP error handling context
    lines.append("    Context 'HTTP error handling' {")
    lines.append('')
    lines.append("        It 'Throws on 404 (not found)' {")
    lines.append(f"            Mock {mock_cmdlet} {{")
    lines.append("                $ex = [System.Net.WebException]::new('The remote server returned an error: (404) Not Found.')")
    lines.append("                throw $ex")
    lines.append("            }")
    lines.append('')
    lines.append(f"            {{ & $ScriptPath {full_call} }} | Should -Throw")
    lines.append("        }")
    lines.append("    }")

    lines.append('}')
    lines.append('')
    return '\n'.join(lines)


def _to_pascal(snake: str) -> str:
    """Convert snake_case to PascalCase."""
    return ''.join(word.capitalize() for word in snake.split('_'))
