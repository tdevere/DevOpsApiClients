"""
bats-core test template for Azure DevOps API operations.
"""

from _generator.operation_def import OperationDef


def render_bats_test(op: OperationDef) -> str:
    """Render a bats-core test file from an OperationDef."""
    lines = []

    lines.append('#!/usr/bin/env bats')
    lines.append('# AUTO-GENERATED by _generator â€” do not edit by hand.')
    lines.append('# ============================================================================')
    lines.append(f'# Offline unit tests for {op.bash_script_name}')
    lines.append('#')
    lines.append('# Uses a stubbed curl function to intercept HTTP calls and return fixture data.')
    lines.append('# ============================================================================')
    lines.append('')
    lines.append('SCRIPT_DIR="$(cd "$(dirname "$BATS_TEST_FILENAME")/.." && pwd)"')
    lines.append('FIXTURES_DIR="$(cd "$(dirname "$BATS_TEST_FILENAME")/fixtures" && pwd)"')
    lines.append('')

    lines.append('setup() {')
    lines.append('    export AZURE_DEVOPS_ORG="testorg"')
    lines.append('    export AZURE_DEVOPS_PAT="fakepat1234567890"')
    if op.project_scoped:
        lines.append('    export PROJECT_ID="a1b2c3d4-e5f6-7890-abcd-ef1234567890"')

    _bats_already_handled = {"AZURE_DEVOPS_ORG", "AZURE_DEVOPS_PAT"}
    if op.project_scoped:
        _bats_already_handled.add("PROJECT_ID")
    for p in op.params:
        if not p.cli_flag and p.env_var not in _bats_already_handled:
            lines.append(f'    export {p.env_var}="test-value-{p.name}"')

    lines.append('    export FIXTURES_DIR')
    lines.append('    export BATS_TMPDIR')
    lines.append('')

    # Build curl stub with URL matching
    lines.append('    STUB_DIR="$(mktemp -d)"')
    lines.append('    cat > "$STUB_DIR/curl" << STUBEOF')
    lines.append('#!/usr/bin/env bash')
    lines.append('echo "\\$@" >> "${BATS_TMPDIR}/curl_args.log"')
    lines.append('for arg in "\\$@"; do')

    # Determine URL pattern to match
    url_pattern = op.url_path.split('{')[0]  # up to the first path param
    lines.append(f'    if [[ "\\$arg" == *"/_apis/{_extract_api_segment(op.url_path)}"*"api-version="* ]]; then')
    lines.append(f'        cat "${{FIXTURES_DIR}}/{op.fixture_filename}"')
    lines.append('        exit 0')
    lines.append('    fi')
    lines.append('done')
    lines.append('echo \'{"error": "no matching stub"}\'')
    lines.append('exit 1')
    lines.append('STUBEOF')
    lines.append('    chmod +x "$STUB_DIR/curl"')
    lines.append('    export ORIGINAL_PATH="$PATH"')
    lines.append('    export PATH="$STUB_DIR:$PATH"')
    lines.append('    export STUB_DIR')
    lines.append('    : > "${BATS_TMPDIR}/curl_args.log"')
    lines.append('}')
    lines.append('')

    lines.append('teardown() {')
    lines.append('    export PATH="$ORIGINAL_PATH"')
    lines.append('    rm -rf "$STUB_DIR"')
    lines.append('    rm -f "${BATS_TMPDIR}/curl_args.log"')
    lines.append('}')
    lines.append('')
    lines.append('')

    # Tests
    lines.append('# ---------------------------------------------------------------------------')
    lines.append('# Tests')
    lines.append('# ---------------------------------------------------------------------------')
    lines.append('')

    # Env validation tests
    lines.append(f'@test "{op.bash_script_name}: exits with error when AZURE_DEVOPS_ORG is unset" {{')
    lines.append('    unset AZURE_DEVOPS_ORG')
    lines.append(f'    run bash "$SCRIPT_DIR/{op.bash_script_name}"')
    lines.append('    [ "$status" -ne 0 ]')
    lines.append('    [[ "$output" == *"AZURE_DEVOPS_ORG"* ]]')
    lines.append('}')
    lines.append('')

    lines.append(f'@test "{op.bash_script_name}: exits with error when AZURE_DEVOPS_PAT is unset" {{')
    lines.append('    unset AZURE_DEVOPS_PAT')
    lines.append(f'    run bash "$SCRIPT_DIR/{op.bash_script_name}"')
    lines.append('    [ "$status" -ne 0 ]')
    lines.append('    [[ "$output" == *"AZURE_DEVOPS_PAT"* ]]')
    lines.append('}')
    lines.append('')

    if op.project_scoped:
        lines.append(f'@test "{op.bash_script_name}: exits with error when PROJECT_ID is unset" {{')
        lines.append('    unset PROJECT_ID')
        lines.append(f'    run bash "$SCRIPT_DIR/{op.bash_script_name}"')
        lines.append('    [ "$status" -ne 0 ]')
        lines.append('    [[ "$output" == *"PROJECT_ID"* ]]')
        lines.append('}')
        lines.append('')

    for p in op.params:
        if not p.cli_flag and p.env_var not in _bats_already_handled:
            lines.append(f'@test "{op.bash_script_name}: exits with error when {p.env_var} is unset" {{')
            lines.append(f'    unset {p.env_var}')
            lines.append(f'    run bash "$SCRIPT_DIR/{op.bash_script_name}"')
            lines.append('    [ "$status" -ne 0 ]')
            lines.append(f'    [[ "$output" == *"{p.env_var}"* ]]')
            lines.append('}')
            lines.append('')

    # Success test
    lines.append(f'@test "{op.bash_script_name}: succeeds with valid env and stubbed curl" {{')
    lines.append(f'    run bash "$SCRIPT_DIR/{op.bash_script_name}"')
    lines.append('    [ "$status" -eq 0 ]')
    lines.append('}')
    lines.append('')

    # Auth test
    lines.append(f'@test "{op.bash_script_name}: sends Authorization header" {{')
    lines.append(f'    run bash "$SCRIPT_DIR/{op.bash_script_name}"')
    lines.append('    [ "$status" -eq 0 ]')
    lines.append('')
    lines.append('    curl_args=$(cat "${BATS_TMPDIR}/curl_args.log")')
    lines.append('    [[ "$curl_args" == *"Authorization: Basic"* ]]')
    lines.append('}')
    lines.append('')

    return '\n'.join(lines)


def _extract_api_segment(url_path: str) -> str:
    """
    Extract a stable segment from the URL path for curl stub matching.
    E.g., '_apis/projects/{project_id}/teams' -> 'projects'
    """
    # Remove _apis/ prefix and find the first stable segment
    path = url_path.replace('_apis/', '')
    parts = path.split('/')
    for part in parts:
        if not part.startswith('{'):
            return part
    return parts[0]
