"""
Bash/cURL implementation template for Azure DevOps API operations.

Generated scripts source _shared/common.sh for consistent auth,
URL building, error handling, and version guards.
"""

from _generator.operation_def import OperationDef


def render_bash(op: OperationDef) -> str:
    """Render a Bash/cURL implementation script from an OperationDef."""
    lines = []

    lines.append('#!/usr/bin/env bash')
    lines.append('# AUTO-GENERATED by _generator â€” do not edit by hand.')
    lines.append('# Source of truth: _generator/definitions/')
    lines.append('# ============================================================================')
    lines.append(f'# {op.synopsis}')
    lines.append('#')
    lines.append(f'# API:  {op.http_method} {{org}}/{op.url_path}?api-version={op.api_version}')
    lines.append('# Auth: Basic (PAT)')
    lines.append('#')

    # Usage hints for required env vars
    env_hints = []
    for p in op.params:
        if not p.cli_flag and p.env_var not in ("AZURE_DEVOPS_ORG", "AZURE_DEVOPS_PAT", "PROJECT_ID"):
            env_hints.append(f'{p.env_var}="value"')
    if env_hints:
        lines.append(f'# Usage: {" ".join(env_hints)} bash {op.bash_script_name}')
        lines.append('#')

    lines.append(f'# Docs: {op.docs_url}')
    lines.append('# ============================================================================')
    lines.append('set -euo pipefail')
    lines.append('')

    # Source shared helpers
    lines.append('# ---------------------------------------------------------------------------')
    lines.append('# Shared helpers')
    lines.append('# ---------------------------------------------------------------------------')
    lines.append('SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"')
    lines.append('source "${SCRIPT_DIR}/../../_shared/common.sh"')
    lines.append('')

    # Configuration
    lines.append('# ---------------------------------------------------------------------------')
    lines.append('# Configuration')
    lines.append('# ---------------------------------------------------------------------------')
    lines.append(f'API_VERSION="{op.api_version}"')
    lines.append('ORG=$(ado_require_env "AZURE_DEVOPS_ORG" "organisation slug")')
    lines.append('PAT=$(ado_require_env "AZURE_DEVOPS_PAT" "Personal Access Token")')
    if op.project_scoped:
        lines.append('PROJECT=$(ado_require_env "PROJECT_ID" "project name or GUID")')

    _bash_already_handled = {"AZURE_DEVOPS_ORG", "AZURE_DEVOPS_PAT"}
    if op.project_scoped:
        _bash_already_handled.add("PROJECT_ID")
    for p in op.params:
        if not p.cli_flag and p.env_var not in _bash_already_handled:
            lines.append(f'{p.env_var}=$(ado_require_env "{p.env_var}" "{p.description}")')
    lines.append('')

    # Auth using shared helper
    lines.append('# ---------------------------------------------------------------------------')
    lines.append('# Auth')
    lines.append('# ---------------------------------------------------------------------------')
    lines.append('AUTH=$(ado_build_auth "$PAT")')
    lines.append('')

    # Body (if applicable)
    if op.body_fields:
        lines.append('# ---------------------------------------------------------------------------')
        lines.append('# Request body')
        lines.append('# ---------------------------------------------------------------------------')
        lines.append('BODY=$(cat <<EOF')
        lines.append('{')
        body_lines = []
        nested = {}
        for bf in op.body_fields:
            val = _resolve_body_source_bash(bf, op)
            if '.' in bf.json_path:
                parts = bf.json_path.split('.', 1)
                parent = parts[0]
                child = parts[1]
                if parent not in nested:
                    nested[parent] = []
                nested[parent].append((child, val))
            else:
                body_lines.append(f'  "{bf.json_path}": {val}')
        for parent, children in nested.items():
            inner = ', '.join(f'"{cn}": {cv}' for cn, cv in children)
            body_lines.append(f'  "{parent}": {{ {inner} }}')
        lines.append(',\n'.join(body_lines))
        lines.append('}')
        lines.append('EOF')
        lines.append(')')
        lines.append('')

    # URL using shared helper
    lines.append('# ---------------------------------------------------------------------------')
    lines.append('# API call')
    lines.append('# ---------------------------------------------------------------------------')

    url_path = op.url_path
    for p in op.params:
        placeholder = '{' + p.name + '}'
        if placeholder in url_path:
            url_path = url_path.replace(placeholder, '${' + p.env_var + '}')

    if op.project_scoped and op.base_host != 'dev.azure.com':
        lines.append(f'URL=$(ado_build_url "$ORG" "{url_path}" "$API_VERSION" "$PROJECT" "{op.base_host}")')
    elif op.project_scoped:
        lines.append(f'URL=$(ado_build_url "$ORG" "{url_path}" "$API_VERSION" "$PROJECT")')
    elif op.base_host != 'dev.azure.com':
        lines.append(f'URL=$(ado_build_url "$ORG" "{url_path}" "$API_VERSION" "" "{op.base_host}")')
    else:
        lines.append(f'URL=$(ado_build_url "$ORG" "{url_path}" "$API_VERSION")')
    lines.append('')

    # curl command
    method = op.http_method
    curl_parts = [
        'RESPONSE=$(curl --silent --fail --show-error \\',
        f'    -X {method} \\',
        '    -H "Authorization: Basic ${AUTH}" \\',
        '    -H "Content-Type: application/json" \\',
    ]
    if op.body_fields:
        curl_parts.append('    -d "$BODY" \\')
    curl_parts.append('    "$URL")')
    lines.extend(curl_parts)
    lines.append('')

    # Version guard using shared helper
    if op.version_guard_keys and op.success_status != 204:
        lines.append('# ---------------------------------------------------------------------------')
        lines.append('# Version guard')
        lines.append('# ---------------------------------------------------------------------------')
        keys_str = ' '.join(f'"{k}"' for k in op.version_guard_keys)
        lines.append(f'ado_version_guard "$RESPONSE" {keys_str}')
        lines.append('')

    # Output
    lines.append('# ---------------------------------------------------------------------------')
    lines.append('# Output')
    lines.append('# ---------------------------------------------------------------------------')
    if op.success_status == 204:
        if op.output_message:
            lines.append(f'echo "{op.output_message}"')
        else:
            lines.append('echo "Operation completed successfully."')
    elif op.output_mode == "message" and op.output_message:
        lines.append(f'echo "{op.output_message}"')
        lines.append('echo "$RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$RESPONSE"')
    else:
        lines.append('echo "$RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$RESPONSE"')

    lines.append('')
    return '\n'.join(lines)


def _resolve_body_source_bash(bf, op):
    """Resolve a body field source to a Bash expression."""
    if bf.source.startswith("param:"):
        pname = bf.source.split(":", 1)[1]
        for p in op.params:
            if p.name == pname:
                return f'"${{{p.env_var}}}"'
        return f'"${{{pname.upper()}}}"'
    elif bf.source.startswith("literal:"):
        val = bf.source.split(":", 1)[1]
        return f'"{val}"'
    return f'"{bf.source}"'
