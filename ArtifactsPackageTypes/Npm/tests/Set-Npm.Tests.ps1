# AUTO-GENERATED by _generator â€” do not edit by hand.
<#
.SYNOPSIS
    Pester offline unit tests for Set-Npm.ps1

.DESCRIPTION
    Mocks Invoke-RestMethod to validate URL construction,
    auth headers, response parsing, and error handling.
#>

BeforeAll {
    $ScriptPath = Join-Path $PSScriptRoot '..' 'Set-Npm.ps1'
    $FixturePath = Join-Path $PSScriptRoot 'fixtures'
    $ProjectGuid = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'
}

Describe 'Set-Npm.ps1' -Tag 'Offline', 'ArtifactsPackageTypes' {

    Context 'Input validation' {

        It 'Throws when Organisation is empty' {
            {
                & $ScriptPath -Organization '' -ProjectId $ProjectGuid -VersionsFromExternalUpstreams 'testvalue' -FeedId 'testvalue' -PackageScope 'testvalue' -UnscopedPackageName 'testvalue' -Pat 'fakepat'
            } | Should -Throw '*is required*'
        }

        It 'Throws when ProjectId is empty' {
            {
                & $ScriptPath -Organization 'testorg' -ProjectId '' -VersionsFromExternalUpstreams 'testvalue' -FeedId 'testvalue' -PackageScope 'testvalue' -UnscopedPackageName 'testvalue' -Pat 'fakepat'
            } | Should -Throw '*is required*'
        }

        It 'Throws when FeedId is empty' {
            {
                & $ScriptPath -Organization 'testorg' -ProjectId $ProjectGuid -VersionsFromExternalUpstreams 'testvalue' -FeedId '' -PackageScope 'testvalue' -UnscopedPackageName 'testvalue' -Pat 'fakepat'
            } | Should -Throw '*is required*'
        }

        It 'Throws when PackageScope is empty' {
            {
                & $ScriptPath -Organization 'testorg' -ProjectId $ProjectGuid -VersionsFromExternalUpstreams 'testvalue' -FeedId 'testvalue' -PackageScope '' -UnscopedPackageName 'testvalue' -Pat 'fakepat'
            } | Should -Throw '*is required*'
        }

        It 'Throws when UnscopedPackageName is empty' {
            {
                & $ScriptPath -Organization 'testorg' -ProjectId $ProjectGuid -VersionsFromExternalUpstreams 'testvalue' -FeedId 'testvalue' -PackageScope 'testvalue' -UnscopedPackageName '' -Pat 'fakepat'
            } | Should -Throw '*is required*'
        }

        It 'Throws when Pat is empty' {
            {
                & $ScriptPath -Organization 'testorg' -ProjectId $ProjectGuid -VersionsFromExternalUpstreams 'testvalue' -FeedId 'testvalue' -PackageScope 'testvalue' -UnscopedPackageName 'testvalue' -Pat ''
            } | Should -Throw '*is required*'
        }
    }

    Context 'Successful API call (mocked)' {

        BeforeAll {
            $fixture = Get-Content (Join-Path $FixturePath 'set_scoped_upstreaming_behavior_200.json') -Raw | ConvertFrom-Json
        }

        It 'Calls the correct URL' {
            Mock Invoke-RestMethod { return $fixture } -Verifiable

            & $ScriptPath -Organization 'testorg' -ProjectId $ProjectGuid -VersionsFromExternalUpstreams 'testvalue' -FeedId 'testvalue' -PackageScope 'testvalue' -UnscopedPackageName 'testvalue' -Pat 'fakepat' | Out-Null

            Should -InvokeVerifiable
            Should -Invoke Invoke-RestMethod -Times 1 -Exactly -ParameterFilter {
                $Uri -eq "https://pkgs.dev.azure.com/testorg/$ProjectGuid/_apis/packaging/feeds/testvalue/npm/packages/@testvalue/testvalue/upstreaming?api-version=7.2" -and
                $Method -eq 'Patch'
            }
        }

        It 'Sends correct Authorization header' {
            $expectedAuth = [Convert]::ToBase64String(
                [Text.Encoding]::ASCII.GetBytes(':fakepat')
            )

            Mock Invoke-RestMethod { return $fixture }

            & $ScriptPath -Organization 'testorg' -ProjectId $ProjectGuid -VersionsFromExternalUpstreams 'testvalue' -FeedId 'testvalue' -PackageScope 'testvalue' -UnscopedPackageName 'testvalue' -Pat 'fakepat' | Out-Null

            Should -Invoke Invoke-RestMethod -Times 1 -ParameterFilter {
                $Headers['Authorization'] -eq "Basic $expectedAuth"
            }
        }
    }

    Context 'HTTP error handling' {

        It 'Throws on 404 (not found)' {
            Mock Invoke-RestMethod {
                $ex = [System.Net.WebException]::new('The remote server returned an error: (404) Not Found.')
                throw $ex
            }

            { & $ScriptPath -Organization 'testorg' -ProjectId $ProjectGuid -VersionsFromExternalUpstreams 'testvalue' -FeedId 'testvalue' -PackageScope 'testvalue' -UnscopedPackageName 'testvalue' -Pat 'fakepat' } | Should -Throw
        }
    }
}
